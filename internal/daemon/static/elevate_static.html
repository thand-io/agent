{{template "header" .}}
<!-- Choices.js CSS and JS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js@10.2.0/public/assets/styles/choices.min.css">
<script src="https://cdn.jsdelivr.net/npm/choices.js@10.2.0/public/assets/scripts/choices.min.js"></script>

<main>
    <div class="container">
        <div class="hero">
            <h1>Static Elevation Request</h1>
            <p>Request temporary elevated privileges for a specific role and reason. Only providers with RBAC support are available for elevation.</p>
            
            <form action="{{.Config.GetApiBasePath}}/elevate" method="GET" style="display: flex; flex-direction: column; gap: 1rem; max-width: 400px; margin: 2rem auto;">
                <div class="form-section">
                    <label class="form-label" for="identities">Select Identities to Assign Role</label>
                    <select name="identities" id="identities" multiple required value="{{if .User.Email}}{{.User.Email}}{{end}}">
                        <!-- Options will be populated dynamically -->
                    </select>
                    <div class="choice-help">
                        Select which users or groups will receive this role. Your current identity is selected by default.
                    </div>
                </div>

                <select name="provider" id="provider" required class="form-select">
                    <option value="">Select a Provider</option>
                </select>
                <select name="role" id="role" required disabled class="form-select" style="opacity: 0.5;">
                    <option value="">Select a Provider First</option>
                </select>
                <select name="duration" required class="form-select">
                    <option value="PT1M">1 Minute</option>
                    <option value="PT5M">5 Minutes</option>
                    <option value="PT15M">15 Minutes</option>
                    <option value="PT30M">30 Minutes</option>
                    <option value="PT1H">1 Hour</option>
                    <option value="PT4H">4 Hours</option>
                    <option value="PT8H">8 Hours</option>
                </select>
                <textarea name="reason" placeholder="Reason for elevation" rows="3" required class="form-textarea"></textarea>
                <button type="submit" class="button button-primary">Request Elevation</button>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const roleSelect = document.getElementById('role');
            const providerSelect = document.getElementById('provider');
            let identityChoices = null;

            // Initialize Choices.js for identity selection
            identityChoices = new Choices('#identities', {
                removeItemButton: true,
                searchEnabled: true,
                placeholder: true,
                placeholderValue: 'Search identities...',
                noResultsText: 'No identities found',
                shouldSort: false,
                searchResultLimit: 50,
                searchFields: ['label', 'value'],
                items: [
                    {{if .User.Email}}{{.User.Email}}{{end}}
                ],
                choices: [
                    {{if .User.Email}}
                    {
                        value: '{{.User.Email}}',
                        label: '{{.User.Email}} (Current User)',
                        selected: true,
                        customProperties: { type: 'user' }
                    }
                    {{end}}
                ],
            });

            // Load identities with current user pre-selected
            loadIdentities();

            function loadIdentities() {
                // Use template value for current user and fetch available identities
                fetch('{{.Config.GetApiBasePath}}/identities')
                .then(response => response.json())
                .then(identitiesData => {
                    const identities = [];
                                        
                    // Add other available identities from the API
                    if (identitiesData && identitiesData.identities) {
                        Object.keys(identitiesData.identities).forEach(key => {
                            const identity = identitiesData.identities[key];
                            
                            const label = identity.name ? 
                                `${identity.name} (${identity.email || identity.id})` : 
                                (identity.email || identity.id);
                            
                            identities.push({
                                id: identity.id,
                                value: identity.email,
                                label: `${label}`,
                                customProperties: { type: 'user' },
                            });
                        });
                    }
                    
                    identityChoices.setChoices(identities, 'value', 'label', true);
                })
                .catch(error => {
                    console.error('Error loading identities:', error);
                    // Fallback to basic options if API calls fail
                    const fallbackIdentities = [
                        { value: 'current-user', label: 'ðŸ‘¤ Current User', selected: true, customProperties: { type: 'user', current: true } }
                    ];
                    identityChoices.setChoices(fallbackIdentities, 'value', 'label', true);
                });
            }

            // Fetch only providers with RBAC capability (those that support elevation)
            fetch('{{.Config.GetApiBasePath}}/providers?capability=rbac')
                .then(response => response.json())
                .then(data => {
                    const providers = data.providers;
                    for (const providerKey in providers) {
                        if (providers.hasOwnProperty(providerKey)) {
                            const option = document.createElement('option');
                            option.value = providerKey;
                            option.textContent = providers[providerKey].name || providerKey;
                            providerSelect.appendChild(option);
                        }
                    }
                })
                .catch(error => console.error('Error fetching RBAC providers:', error));

            // Handle provider selection change
            providerSelect.addEventListener('change', function() {
                const selectedProvider = this.value;
                
                // Clear existing role options
                roleSelect.innerHTML = '<option value="">Select a Role</option>';
                
                if (selectedProvider) {
                    // Enable role select
                    roleSelect.disabled = false;
                    roleSelect.style.opacity = '1';
                    
                    // Fetch roles filtered by the selected provider
                    fetch(`{{.Config.GetApiBasePath}}/roles?provider=${selectedProvider}`)
                        .then(response => response.json())
                        .then(data => {
                            const roles = data.roles;
                            let hasRoles = false;
                            
                            for (const roleKey in roles) {
                                if (roles.hasOwnProperty(roleKey)) {
                                    const role = roles[roleKey];
                                    const option = document.createElement('option');
                                    option.value = roleKey;
                                    option.textContent = role.name || roleKey;
                                    roleSelect.appendChild(option);
                                    hasRoles = true;
                                }
                            }
                            
                            // If no roles found for this provider, show message
                            if (!hasRoles) {
                                const option = document.createElement('option');
                                option.value = '';
                                option.textContent = 'No roles available for this provider';
                                option.disabled = true;
                                roleSelect.appendChild(option);
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching roles for provider:', error);
                            const option = document.createElement('option');
                            option.value = '';
                            option.textContent = 'Error loading roles';
                            option.disabled = true;
                            roleSelect.appendChild(option);
                        });
                } else {
                    // Disable role select if no provider selected
                    roleSelect.disabled = true;
                    roleSelect.style.opacity = '0.5';
                    roleSelect.innerHTML = '<option value="">Select a Provider First</option>';
                }
            });

            // Add form validation
            document.querySelector('form').addEventListener('submit', function(e) {
                const selectedIdentities = identityChoices.getValue();
                if (selectedIdentities.length === 0) {
                    e.preventDefault();
                    alert('Please select at least one identity to assign the role to');
                    return false;
                }
            });
        });
    </script>
</main>
{{template "footer" .}}
