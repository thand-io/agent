{{template "header" .}}
<main>
    <div class="container">
        <div class="hero">
            <h1>Static Elevation Request</h1>
            <p>Request temporary elevated privileges for a specific role and reason. Only providers with RBAC support are available for elevation.</p>
            
            <form action="{{.Config.GetApiBasePath}}/elevate" method="GET" style="display: flex; flex-direction: column; gap: 1rem; max-width: 400px; margin: 2rem auto;">
                <select name="provider" id="provider" required style="padding: 0.75rem; border-radius: 0.375rem; border: 1px solid hsl(var(--border)); background-color: hsl(var(--input)); color: hsl(var(--foreground));">
                    <option value="">Select a Provider</option>
                </select>
                <select name="role" id="role" required disabled style="padding: 0.75rem; border-radius: 0.375rem; border: 1px solid hsl(var(--border)); background-color: hsl(var(--input)); color: hsl(var(--foreground)); opacity: 0.5;">
                    <option value="">Select a Provider First</option>
                </select>
                <select name="duration" required style="padding: 0.75rem; border-radius: 0.375rem; border: 1px solid hsl(var(--border)); background-color: hsl(var(--input)); color: hsl(var(--foreground));">
                    <option value="PT1M">1 Minute</option>
                    <option value="PT5M">5 Minutes</option>
                    <option value="PT15M">15 Minutes</option>
                    <option value="PT30M">30 Minutes</option>
                    <option value="PT1H">1 Hour</option>
                    <option value="PT4H">4 Hours</option>
                    <option value="PT8H">8 Hours</option>
                </select>
                <textarea name="reason" placeholder="Reason for elevation" rows="3" required style="padding: 0.75rem; border-radius: 0.375rem; border: 1px solid hsl(var(--border)); background-color: hsl(var(--input)); color: hsl(var(--foreground));"></textarea>
                <button type="submit" class="button button-primary">Request Elevation</button>
            </form>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const roleSelect = document.getElementById('role');
            const providerSelect = document.getElementById('provider');

            // Fetch only providers with RBAC capability (those that support elevation)
            fetch('{{.Config.GetApiBasePath}}/providers?capability=rbac')
                .then(response => response.json())
                .then(data => {
                    const providers = data.providers;
                    for (const providerKey in providers) {
                        if (providers.hasOwnProperty(providerKey)) {
                            const option = document.createElement('option');
                            option.value = providerKey;
                            option.textContent = providers[providerKey].name || providerKey;
                            providerSelect.appendChild(option);
                        }
                    }
                })
                .catch(error => console.error('Error fetching RBAC providers:', error));

            // Handle provider selection change
            providerSelect.addEventListener('change', function() {
                const selectedProvider = this.value;
                
                // Clear existing role options
                roleSelect.innerHTML = '<option value="">Select a Role</option>';
                
                if (selectedProvider) {
                    // Enable role select
                    roleSelect.disabled = false;
                    roleSelect.style.opacity = '1';
                    
                    // Fetch roles filtered by the selected provider
                    fetch(`{{.Config.GetApiBasePath}}/roles?provider=${selectedProvider}`)
                        .then(response => response.json())
                        .then(data => {
                            const roles = data.roles;
                            let hasRoles = false;
                            
                            for (const roleKey in roles) {
                                if (roles.hasOwnProperty(roleKey)) {
                                    const role = roles[roleKey];
                                    const option = document.createElement('option');
                                    option.value = roleKey;
                                    option.textContent = role.name || roleKey;
                                    roleSelect.appendChild(option);
                                    hasRoles = true;
                                }
                            }
                            
                            // If no roles found for this provider, show message
                            if (!hasRoles) {
                                const option = document.createElement('option');
                                option.value = '';
                                option.textContent = 'No roles available for this provider';
                                option.disabled = true;
                                roleSelect.appendChild(option);
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching roles for provider:', error);
                            const option = document.createElement('option');
                            option.value = '';
                            option.textContent = 'Error loading roles';
                            option.disabled = true;
                            roleSelect.appendChild(option);
                        });
                } else {
                    // Disable role select if no provider selected
                    roleSelect.disabled = true;
                    roleSelect.style.opacity = '0.5';
                    roleSelect.innerHTML = '<option value="">Select a Provider First</option>';
                }
            });
        });
    </script>
</main>
{{template "footer" .}}
