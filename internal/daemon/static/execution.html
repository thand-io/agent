{{template "header" .}}
    <main>
        <div class="container" style="width: 100%;">
            <div class="hero">
                {{if eq .Workflow.GetStatus "completed"}}
                    <!-- Success State -->
                    <h1>Workflow Complete</h1>
                    <p>Your workflow has been successfully completed. All tasks have been executed and the process is finished.</p>
                    
                    <div class="button-group">
                        <a href="/" class="button button-primary">Back to Home</a>
                        <a href="/elevate" class="button button-secondary">New Request</a>
                    </div>

                    <div class="status-card">
                        <div class="status-indicator">
                            <div class="status-dot"></div>
                            <span>Status: <strong>{{.Workflow.GetStatus}}</strong></span>
                        </div>
                        <div style="margin-top: 0.5rem; font-size: 0.875rem; color: hsl(var(--muted-foreground));">
                            Workflow ID: {{.Workflow.WorkflowID}} | Completed: {{.Workflow.StartedAt}}
                        </div>
                        {{if .Workflow.GetOutput}}
                        <div style="margin-top: 0.75rem; padding: 0.75rem; background-color: hsl(var(--secondary)); border-radius: 0.375rem; font-size: 0.875rem;">
                            <strong>Result:</strong> {{.Workflow.GetOutput}}
                        </div>
                        {{end}}
                    </div>
                {{else}}
                    <!-- In Progress State -->
                    <h1>Workflow in Progress</h1>
                    <p>Your workflow is currently being processed. Please wait while we execute the required tasks.</p>
                    
                    <div class="button-group">
                        <button onclick="refreshPage()" class="button button-primary" id="refresh-btn" {{if not .Config.GetServices.HasTemporal}}style="display:none"{{end}}>Refresh Status</button>
                        <a href="/" class="button button-secondary">Back to Home</a>
                    </div>

                    <div class="workflow-details">
                        <div class="status-card" style="max-width: 600px;">
                            <div class="status-indicator">
                                <div class="status-dot {{if eq .Workflow.GetStatus "FAILED"}}offline{{end}}" id="workflow-status-dot"></div>
                                <span>Status: <strong id="workflow-status">{{.Workflow.GetStatus}}</strong></span>
                            </div>
                            <div style="margin-top: 0.5rem; font-size: 0.875rem; color: hsl(var(--muted-foreground));">
                                Workflow ID: <span id="workflow-id">{{.Workflow.WorkflowID}}</span> | Started: <span id="workflow-started">{{.Workflow.StartedAt}}</span>
                            </div>
                            
                            <div id="current-task-container" {{if not .Workflow.GetTaskName}}style="display:none"{{end}}>
                                <div style="margin-top: 0.75rem; padding: 0.75rem; background-color: hsl(var(--secondary)); border-radius: 0.375rem;">
                                    <div style="font-size: 0.875rem; font-weight: 500; margin-bottom: 0.25rem;">Current Task:</div>
                                    <div style="font-size: 0.875rem;" id="current-task">{{.Workflow.GetTaskName}}</div>
                                </div>
                            </div>

                            <div id="workflow-output-container" {{if not .Workflow.GetOutput}}style="display:none"{{end}}>
                                <div style="margin-top: 0.75rem; padding: 0.75rem; background-color: hsl(var(--secondary)); border-radius: 0.375rem; font-size: 0.875rem;">
                                    <strong>Result:</strong> <span id="workflow-output">{{.Workflow.GetOutput}}</span>
                                </div>
                            </div>

                        </div>
                    </div>
                {{end}}
            </div>
        </div>
    </main>

    <script>
        let refreshInterval;
        const workflowId = '{{.Workflow.WorkflowID}}';
        const temporalAvailable = {{.Config.GetServices.HasTemporal}}

        function refreshPage() {
            window.location.reload();
        }

        function updateWorkflowStatus(data) {
            // Update status
            const statusElement = document.getElementById('workflow-status');
            const statusDotElement = document.getElementById('workflow-status-dot');
            
            if (statusElement && data.workflow) {
                statusElement.textContent = data.workflow.status || data.workflow.Status;
            }
            
            if (statusDotElement && data.workflow) {
                statusDotElement.className = `status-dot ${data.workflow.status === 'FAILED' ? 'offline' : ''}`;
            }

            // Update workflow started time
            const startedElement = document.getElementById('workflow-started');
            if (startedElement && data.workflow && data.workflow.started_at) {
                startedElement.textContent = new Date(data.workflow.started_at).toLocaleString();
            }

            // If workflow is completed or failed, redirect to refresh the page to show the correct state
            if (data.workflow && (
                data.workflow.status === 'COMPLETED' || 
                data.workflow.status === 'FAILED'
            )) {
                clearInterval(refreshInterval);
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            }
        }

        function fetchWorkflowStatus() {
            fetch(`{{.Config.GetApiBasePath}}/execution/${workflowId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch workflow status');
                    }
                    return response.json();
                })
                .then(data => {
                    updateWorkflowStatus(data);
                })
                .catch(error => {
                    console.error('Error fetching workflow status:', error);
                    // If there's an error, stop auto-refresh
                    clearInterval(refreshInterval);
                });
        }

        // Only start auto-refresh if temporal is available and workflow is not completed
        if (temporalAvailable && 
            '{{.Workflow.GetStatus}}' !== 'COMPLETED' &&
            '{{.Workflow.GetStatus}}' !== 'FAILED') {
            
            // Start auto-refresh every 5 seconds
            refreshInterval = setInterval(fetchWorkflowStatus, 5000);
            
            // Clean up interval when page is unloaded
            window.addEventListener('beforeunload', function() {
                if (refreshInterval) {
                    clearInterval(refreshInterval);
                }
            });
        }
    </script>

{{template "footer" .}}
