{{template "header" .}}
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <main x-data="workflowApp()" x-init="init()">
        <div class="container" style="width: 100%;">
            <!-- Loading State -->
            <div x-show="loading" style="text-align: center; padding: 2rem;">
                <h1>Loading Workflow...</h1>
                <div class="status-dot connecting" style="width: 2rem; height: 2rem; margin: 1rem auto;"></div>
            </div>
            
            <!-- Error State -->
            <div x-show="error && !loading" style="text-align: center; padding: 2rem;">
                <h1>Error Loading Workflow</h1>
                <p x-text="error"></p>
                <button @click="fetchWorkflowStatus()" class="button button-primary">Retry</button>
            </div>
            
            <!-- Workflow Content -->
            <div x-show="execution && !loading && !error">
                <!-- Page Header -->
                <div class="page-header" style="margin-bottom: 1rem;">
                    <h1 x-text="getWorkflowName()"></h1>
                </div>
                
                <div style="margin-bottom: 2rem;">
                    <!-- Workflow Progress -->
                    <div style="margin-bottom: 1.5rem;">
                        <template x-if="hasWorkflowTasks()">
                            <div style="position: relative; overflow: hidden; padding: 2rem 0;">
                                <!-- Fade gradients -->
                                <div style="position: absolute; left: 0; top: 0; bottom: 0; width: 2rem; background: linear-gradient(to right, hsl(var(--background)), transparent); z-index: 1; pointer-events: none;"></div>
                                <div style="position: absolute; right: 0; top: 0; bottom: 0; width: 2rem; background: linear-gradient(to left, hsl(var(--background)), transparent); z-index: 1; pointer-events: none;"></div>
                                
                                <!-- Tasks Container -->
                                <div style="display: flex; align-items: center; gap: 1.5rem; justify-content: center; padding: 0 2rem; min-height: 4rem; scrollbar-width: none; -ms-overflow-style: none;">
                                    <template x-for="(task, index) in getTasks()" :key="index">
                                        <div class="workflow-task" 
                                             :class="{ 'workflow-task-current': isCurrentTask(task) }"
                                             style="display: flex; flex-direction: column; align-items: center; min-width: 140px; padding: 1rem; border-radius: 0.5rem; transition: all 0.3s ease; flex-shrink: 0; position: relative;"
                                             :style="{
                                                 'background': isCurrentTask(task) ? `linear-gradient(135deg, ${getTaskColor(task)}15, ${getTaskColor(task)}25)` : (hasTaskExecuted(task) ? 'hsl(var(--card))' : 'hsl(var(--muted))'),
                                                 'border': isCurrentTask(task) ? `2px solid ${getTaskColor(task)}` : '1px solid hsl(var(--border))',
                                                 'box-shadow': isCurrentTask(task) ? `0 0 0 3px ${getTaskColor(task)}50` : 'none',
                                                 'transform': isCurrentTask(task) ? 'scale(1.05)' : 'scale(1)',
                                                 'opacity': !hasTaskExecuted(task) && !isCurrentTask(task) ? '0.6' : '1'
                                             }">
                                            
                                            <!-- Task Number Badge -->
                                            <div style="position: absolute; top: -12px; left: -12px; width: 28px; height: 28px; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.875rem; font-weight: 700; z-index: 2;"
                                                 :style="{ 'background-color': isCurrentTask(task) ? getTaskColor(task) : (hasTaskExecuted(task) ? '#10b981' : '#6b7280') }"
                                                 x-text="index">
                                            </div>
                                            
                                            <!-- Task Type Indicator -->
                                            <div style="position: absolute; top: -8px; right: -8px; width: 20px; height: 20px; border-radius: 50%; z-index: 2; border: 2px solid white;"
                                                 :style="{ 'background-color': getTaskColor(task) }">
                                            </div>
                                            
                                            <!-- Status Indicator -->
                                            <div style="margin-bottom: 0.5rem; margin-top: 0.5rem;">
                                                <div :class="getTaskStatusDotClass(task)" 
                                                     :style="{
                                                         'width': isCurrentTask(task) ? '1.25rem' : (hasTaskExecuted(task) ? '1rem' : '1rem'),
                                                         'height': isCurrentTask(task) ? '1.25rem' : (hasTaskExecuted(task) ? '1rem' : '1rem'),
                                                         'border-radius': !hasTaskExecuted(task) && !isCurrentTask(task) ? '50%' : '',
                                                         'background-color': !hasTaskExecuted(task) && !isCurrentTask(task) ? 'hsl(var(--muted-foreground))' : '',
                                                         'opacity': !hasTaskExecuted(task) && !isCurrentTask(task) ? '0.3' : '1'
                                                     }">
                                                </div>
                                            </div>
                                            
                                            <!-- Task Name -->
                                            <div style="text-align: center; margin-bottom: 0.5rem; word-break: break-word; font-size: 0.875rem;"
                                                 :style="{
                                                     'font-weight': isCurrentTask(task) ? '700' : '600',
                                                     'color': isCurrentTask(task) ? getTaskColor(task) : (hasTaskExecuted(task) ? 'hsl(var(--foreground))' : 'hsl(var(--muted-foreground))')
                                                 }"
                                                 x-text="getTaskKey(task)">
                                            </div>
                                            
                                            <!-- Status Badge -->
                                            <div :class="getTaskBadgeClass(task)"
                                                 style="font-size: 0.75rem; padding: 0.25rem 0.5rem;"
                                                 :style="{
                                                     'background-color': isCurrentTask(task) ? getTaskColor(task) : '',
                                                     'color': isCurrentTask(task) ? 'white' : '',
                                                     'font-weight': isCurrentTask(task) ? '600' : '',
                                                     'opacity': !hasTaskExecuted(task) && !isCurrentTask(task) ? '0.6' : '1'
                                                 }"
                                                 x-text="getTaskBadgeText(task)">
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </template>
                        
                        <!-- Task Type Legend -->
                        <div style="display: flex; justify-content: center; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; margin-top: 1rem;">
                            <div style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.75rem; color: hsl(var(--muted-foreground));">
                                <div style="width: 12px; height: 12px; border-radius: 50%; background-color: #3b82f6;"></div>
                                <span>Call</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.75rem; color: hsl(var(--muted-foreground));">
                                <div style="width: 12px; height: 12px; border-radius: 50%; background-color: #8b5cf6;"></div>
                                <span>Fork</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.75rem; color: hsl(var(--muted-foreground));">
                                <div style="width: 12px; height: 12px; border-radius: 50%; background-color: #10b981;"></div>
                                <span>Emit</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.75rem; color: hsl(var(--muted-foreground));">
                                <div style="width: 12px; height: 12px; border-radius: 50%; background-color: #f59e0b;"></div>
                                <span>Run</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.75rem; color: hsl(var(--muted-foreground));">
                                <div style="width: 12px; height: 12px; border-radius: 50%; background-color: #ef4444;"></div>
                                <span>Switch</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.75rem; color: hsl(var(--muted-foreground));">
                                <div style="width: 12px; height: 12px; border-radius: 50%; background-color: #6b7280;"></div>
                                <span>Other</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Current Step Details -->
                    <template x-if="hasCurrentTask()">
                        <div style="padding: 1.5rem; background-color: hsl(var(--card)); border: 1px solid hsl(var(--border)); border-radius: 0.5rem;">
                            <h4 style="margin-bottom: 1rem; font-size: 1rem; font-weight: 600;">
                                Current Step: <span x-text="execution.entrypoint"></span>
                            </h4>
                            <div style="display: grid; gap: 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="font-size: 0.875rem; color: hsl(var(--muted-foreground));">Status:</span>
                                    <div :class="getWorkflowStatusBadgeClass()" x-text="execution?.Status || execution?.status"></div>
                                </div>
                                
                                <template x-if="hasWorkflowContext()">
                                    <div>
                                        <div style="font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem; color: hsl(var(--muted-foreground));">Workflow Context:</div>
                                        <div style="padding: 0.75rem; background-color: hsl(var(--secondary)); border-radius: 0.375rem; font-size: 0.875rem; font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', 'Consolas', monospace; white-space: pre-wrap; overflow-x: auto; line-height: 1.5;">
                                            <pre style="margin: 0; background: none; border: none; padding: 0; font-size: inherit; font-family: inherit; white-space: pre-wrap; overflow-x: auto;" x-text="getWorkflowContextJson()"></pre>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>
                    
                    <!-- Workflow Complete/Failed States -->
                    <template x-if="!hasCurrentTask()">
                        <div style="padding: 1.5rem; background-color: hsl(var(--card)); border: 1px solid hsl(var(--border)); border-radius: 0.5rem; text-align: center;">
                            <template x-if="isWorkflowCompleted()">
                                <div>
                                    <h4 style="color: hsl(var(--success)); margin-bottom: 0.5rem;">✓ Workflow Complete</h4>
                                    <p style="color: hsl(var(--muted-foreground)); font-size: 0.875rem;">All tasks have been executed successfully.</p>
                                    <div style="margin-top: 1rem;">
                                        <a href="/" class="button button-primary" style="margin-right: 0.5rem;">Back to Home</a>
                                        <a href="/elevate" class="button button-secondary">New Request</a>
                                    </div>
                                </div>
                            </template>
                            
                            <template x-if="isWorkflowFailed()">
                                <div>
                                    <h4 style="color: hsl(var(--destructive)); margin-bottom: 0.5rem;">✗ Workflow Failed</h4>
                                    <p style="color: hsl(var(--muted-foreground)); font-size: 0.875rem;">The workflow encountered an error and could not complete.</p>
                                    <div style="margin-top: 1rem;">
                                        <a href="/" class="button button-primary" style="margin-right: 0.5rem;">Back to Home</a>
                                        <a href="/elevate" class="button button-secondary">Try Again</a>
                                    </div>
                                </div>
                            </template>
                            
                            <template x-if="!isWorkflowCompleted() && !isWorkflowFailed()">
                                <div>
                                    <h4 style="margin-bottom: 0.5rem;">Workflow Initializing</h4>
                                    <p style="color: hsl(var(--muted-foreground)); font-size: 0.875rem;">Please wait while the workflow starts...</p>
                                    <div style="margin-top: 1rem;">
                                        <button @click="fetchWorkflowStatus()" class="button button-primary">Refresh Status</button>
                                        <a href="/" class="button button-secondary">Back to Home</a>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
            </div>
        </div>
        
        <!-- Alpine.js styles -->
        <style>
            .workflow-task-current {
                animation: pulse 2s infinite;
            }
            @keyframes pulse {
                0%, 100% { 
                    transform: scale(1.05);
                    opacity: 1;
                }
                50% { 
                    transform: scale(1.1);
                    opacity: 0.8;
                }
            }
        </style>
    </main>

    <script>
        function workflowApp() {
            return {
                // Initial data from server
                workflowId: '{{.Execution.WorkflowID}}',
                apiBasePath: '{{.Config.GetApiBasePath}}',
                temporalAvailable: {{.Config.GetServices.HasTemporal}},
                
                // Reactive state
                loading: true,
                error: null,
                execution: null,
                workflow: null,
                refreshInterval: null,
                
                // Task type colors mapping
                taskColors: {
                    call: '#3b82f6',
                    fork: '#8b5cf6', 
                    emit: '#10b981',
                    run: '#f59e0b',
                    switch: '#ef4444',
                    listen: '#06b6d4',
                    wait: '#84cc16',
                    set: '#f97316',
                    raise: '#dc2626',
                    try: '#7c2d12',
                    for: '#be185d',
                    do: '#6366f1',
                    default: '#6b7280'
                },
                
                // Initialize the app
                init() {
                    // Load initial data
                    this.execution = {{.Execution | toJSON}};
                    this.workflow = {{.Workflow | toJSON}}; // Will be populated by fetchWorkflowStatus or from execution data
                    this.loading = false;
                    
                    // Start auto-refresh if needed
                    if (this.temporalAvailable && !this.isWorkflowComplete()) {
                        this.startAutoRefresh();
                    }
                },
                
                // Fetch workflow status from API
                async fetchWorkflowStatus() {
                    try {
                        console.log('Fetching workflow status for ID:', this.workflowId);
                        const response = await fetch(`${this.apiBasePath}/execution/${this.workflowId}`);
                        
                        if (!response.ok) {
                            throw new Error(`Failed to fetch: ${response.status} ${response.statusText}`);
                        }
                        
                        const data = await response.json();
                        console.log('Received workflow data:', data);
                        
                        // Handle new response structure: { workflow: {...}, execution: {...} }
                        this.execution = data.execution;
                        this.workflow = data.workflow;
                        this.error = null;
                        
                        // Stop auto-refresh if workflow is complete
                        if (this.isWorkflowComplete()) {
                            this.stopAutoRefresh();
                        }
                        
                    } catch (err) {
                        console.error('Error fetching workflow status:', err);
                        this.error = err.message;
                        this.stopAutoRefresh();
                    }
                },
                
                // Auto-refresh management
                startAutoRefresh() {
                    this.refreshInterval = setInterval(() => {
                        this.fetchWorkflowStatus();
                    }, 5000);
                },
                
                stopAutoRefresh() {
                    if (this.refreshInterval) {
                        clearInterval(this.refreshInterval);
                        this.refreshInterval = null;
                    }
                },
                
                // Task helper methods
                getTasks() {
                    return this.workflow?.do || [];
                },
                
                getTaskKey(task) {
                    return Object.keys(task)[0];
                },
                
                getTaskDefinition(task) {
                    const key = this.getTaskKey(task);
                    return task[key];
                },
                
                getTaskType(task) {
                    const taskDef = this.getTaskDefinition(task);
                    
                    if (taskDef.call) return 'call';
                    if (taskDef.fork) return 'fork';
                    if (taskDef.emit) return 'emit';
                    if (taskDef.run) return 'run';
                    if (taskDef.switch) return 'switch';
                    if (taskDef.listen) return 'listen';
                    if (taskDef.wait) return 'wait';
                    if (taskDef.set) return 'set';
                    if (taskDef.raise) return 'raise';
                    if (taskDef.try) return 'try';
                    if (taskDef.for) return 'for';
                    if (taskDef.do) return 'do';
                    
                    return 'task';
                },
                
                getTaskColor(task) {
                    const type = this.getTaskType(task);
                    return this.taskColors[type] || this.taskColors.default;
                },
                
                isCurrentTask(task) {
                    return this.getTaskKey(task) === this.execution?.entrypoint;
                },
                
                hasTaskExecuted(task) {
                    const taskKey = this.getTaskKey(task);
                    const taskLogs = this.execution?.tasks?.[taskKey] || [];
                    return taskLogs.length > 0;
                },
                
                getLatestTaskStatus(task) {
                    const taskKey = this.getTaskKey(task);
                    const taskLogs = this.execution?.tasks?.[taskKey] || [];
                    return taskLogs.length > 0 ? taskLogs[taskLogs.length - 1].phase : 'pending';
                },
                
                getTaskStatusDotClass(task) {
                    const isCurrent = this.isCurrentTask(task);
                    const hasExecuted = this.hasTaskExecuted(task);
                    const status = this.getLatestTaskStatus(task);
                    
                    let classes = ['status-dot'];
                    
                    if (isCurrent) {
                        classes.push('connecting');
                    } else if (hasExecuted) {
                        if (status === 'completed') classes.push('success');
                        else if (status === 'running') classes.push('connecting');
                        else if (status === 'failed') classes.push('error');
                    }
                    
                    return classes.join(' ');
                },
                
                getTaskBadgeClass(task) {
                    const isCurrent = this.isCurrentTask(task);
                    const hasExecuted = this.hasTaskExecuted(task);
                    const status = this.getLatestTaskStatus(task);
                    
                    let classes = ['badge'];
                    
                    if (isCurrent) {
                        // Current task uses inline styles
                    } else if (hasExecuted) {
                        if (status === 'completed') classes.push('badge-success');
                        else if (status === 'running') classes.push('badge-warning');
                        else if (status === 'failed') classes.push('badge-error');
                        else classes.push('badge-secondary');
                    } else {
                        classes.push('badge-secondary');
                    }
                    
                    return classes.join(' ');
                },
                
                getTaskBadgeText(task) {
                    const isCurrent = this.isCurrentTask(task);
                    const hasExecuted = this.hasTaskExecuted(task);
                    
                    if (isCurrent) {
                        return 'CURRENT';
                    } else if (hasExecuted) {
                        return this.getLatestTaskStatus(task);
                    } else {
                        return this.getTaskType(task).toUpperCase();
                    }
                },
                
                // Workflow status methods
                getWorkflowStatusBadgeClass() {
                    const status = this.execution?.status;
                    if (status === 'completed' || status === 'COMPLETED') return 'badge badge-success';
                    if (status === 'FAILED' || status === 'failed') return 'badge badge-error';
                    return 'badge badge-warning';
                },
                
                isWorkflowCompleted() {
                    const status = this.execution?.status;
                    return status === 'completed' || status === 'COMPLETED';
                },
                
                isWorkflowFailed() {
                    const status = this.execution?.status;
                    return status === 'FAILED' || status === 'failed';
                },
                
                isWorkflowComplete() {
                    return this.isWorkflowCompleted() || this.isWorkflowFailed();
                },
                
                hasWorkflowTasks() {
                    return this.getTasks().length > 0;
                },
                
                hasCurrentTask() {
                    return !!this.execution?.entrypoint;
                },
                
                hasWorkflowContext() {
                    return !!this.execution?.context;
                },
                
                getWorkflowContextJson() {
                    return JSON.stringify(this.execution?.context, null, 2);
                },
                
                getWorkflowName() {
                    return this.workflow?.document?.name || this.workflow?.name || this.execution?.workflow_id || 'Unknown Workflow';
                },
                
                // Cleanup
                destroy() {
                    this.stopAutoRefresh();
                }
            }
        }
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            // Alpine.js will handle cleanup automatically
        });
    </script>

{{template "footer" .}}
